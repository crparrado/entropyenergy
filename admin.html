<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mantenedor de productos</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    body {
      background: #050a13;
      color: #f1f6ff;
      font-family: 'Outfit', sans-serif;
      margin: 0;
      min-height: 100vh;
    }
    main {
      width: min(1200px, 95vw);
      margin: 3rem auto;
      background: rgba(5, 16, 28, 0.85);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 1.2rem;
      padding: 2rem;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
    }
    h1 {
      margin-top: 0;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1.5rem;
    }
    th, td {
      border: 1px solid rgba(255, 255, 255, 0.08);
      padding: 0.6rem;
      text-align: left;
      vertical-align: top;
    }
    thead {
      background: rgba(0, 216, 180, 0.12);
    }
    input, textarea, select {
      width: 100%;
      border-radius: 0.5rem;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(3, 10, 18, 0.8);
      color: #f1f6ff;
      padding: 0.4rem 0.6rem;
      font-family: inherit;
    }
    textarea {
      min-height: 70px;
      resize: vertical;
    }
    .actions {
      margin-top: 1rem;
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 0.6rem 1.2rem;
      font-weight: 600;
      cursor: pointer;
    }
    .primary {
      background: linear-gradient(135deg, #00d8b4 0%, #00a4ff 100%);
      color: #05121c;
    }
    .ghost {
      background: transparent;
      border: 1px solid rgba(0, 216, 180, 0.4);
      color: #00d8b4;
    }
    .note {
      color: #9fb3d6;
      font-size: 0.9rem;
      margin-top: 0.5rem;
    }
    .danger {
      color: #ff884d;
      cursor: pointer;
    }
    .status {
      font-size: 0.9rem;
      margin-top: 0.5rem;
      color: #9fb3d6;
    }
    .status--success {
      color: #00d8b4;
    }
    .status--error {
      color: #ff884d;
    }
  </style>
</head>
<body>
  <main>
    <h1>Mantenedor de productos</h1>
    <p>Usa este panel para editar los datos mostrados en la pestaña <strong>Productos</strong>. Ahora puedes guardar tus cambios directamente en el navegador y el resto del sitio los leerá de inmediato.</p>
    <p class="note">Campos "Imágenes" e "Incluye" aceptan una línea por elemento. Los valores numéricos admiten decimales. Puedes descargar un respaldo en JSON o restablecer los valores originales cuando lo necesites.</p>
    <table id="productTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>Nombre</th>
          <th>Categoría</th>
          <th>Potencia (W)</th>
          <th>Capacidad (Wh)</th>
          <th>Precio CLP</th>
          <th>Stock</th>
          <th>Resumen</th>
          <th>Imágenes (una por línea)</th>
          <th>Incluye (una por línea)</th>
          <th>Ficha técnica</th>
          <th></th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="actions">
      <button type="button" class="primary" id="saveProducts">Guardar cambios (se aplican en este navegador)</button>
      <button type="button" id="addProduct">Agregar producto</button>
      <button type="button" class="ghost" id="exportJson">Descargar JSON actualizado</button>
      <button type="button" class="ghost" id="resetCatalog">Restablecer desde JSON original</button>
    </div>
    <p id="saveStatus" class="status"></p>
  </main>

  <script type="module">
    import { loadCatalog, saveCatalog, clearCatalogOverride } from './catalog.js';

    const tableBody = document.querySelector('#productTable tbody');
    const addButton = document.getElementById('addProduct');
    const exportButton = document.getElementById('exportJson');
    const saveButton = document.getElementById('saveProducts');
    const resetButton = document.getElementById('resetCatalog');
    const statusNode = document.getElementById('saveStatus');
    let products = [];

    function setStatus(message, tone = 'info') {
      if (!statusNode) return;
      statusNode.textContent = message;
      statusNode.classList.remove('status--success', 'status--error');
      if (tone === 'success') {
        statusNode.classList.add('status--success');
      } else if (tone === 'error') {
        statusNode.classList.add('status--error');
      }
    }

    async function init() {
      try {
        products = await loadCatalog();
        renderTable();
        setStatus('Catálogo cargado. Guarda los cambios para aplicarlos al sitio.', 'success');
      } catch (error) {
        console.error('No se pudo cargar el catálogo', error);
        products = [];
        renderTable();
        setStatus('No se pudo cargar el catálogo base. Revisa la consola.', 'error');
      }
    }

    function renderTable() {
      tableBody.innerHTML = '';
      if (products.length === 0) {
        const empty = document.createElement('tr');
        const cell = document.createElement('td');
        cell.colSpan = 12;
        cell.textContent = 'Aún no hay productos. Agrega uno nuevo para comenzar.';
        empty.appendChild(cell);
        tableBody.appendChild(empty);
        return;
      }
      products.forEach((product, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td><input data-field="id" data-index="${index}" value="${product.id || ''}"></td>
          <td><input data-field="name" data-index="${index}" value="${product.name || ''}"></td>
          <td><input data-field="category" data-index="${index}" value="${product.category || ''}"></td>
          <td><input type="number" data-field="power_w" data-index="${index}" value="${product.power_w ?? ''}"></td>
          <td><input type="number" data-field="capacity_wh" data-index="${index}" value="${product.capacity_wh ?? ''}"></td>
          <td><input type="number" data-field="price_clp" data-index="${index}" value="${product.price_clp ?? ''}"></td>
          <td><input type="number" data-field="stock" data-index="${index}" value="${product.stock ?? ''}"></td>
          <td><textarea data-field="summary" data-index="${index}">${product.summary || ''}</textarea></td>
          <td><textarea data-field="images" data-index="${index}">${(product.images || []).join('\n')}</textarea></td>
          <td><textarea data-field="includes" data-index="${index}">${(product.includes || []).join('\n')}</textarea></td>
          <td><input data-field="datasheet" data-index="${index}" value="${product.datasheet || ''}"></td>
          <td><button type="button" class="danger" data-remove="${index}">Eliminar</button></td>
        `;
        tableBody.appendChild(row);
      });
    }

    tableBody.addEventListener('input', (event) => {
      const target = event.target;
      const index = Number(target.dataset.index);
      const field = target.dataset.field;
      if (!Number.isInteger(index) || !field) return;
      let value = target.value;
      if (['power_w', 'capacity_wh', 'price_clp', 'stock'].includes(field)) {
        value = value === '' ? null : Number(value);
      } else if (field === 'images' || field === 'includes') {
        value = value
          .split('\n')
          .map((item) => item.trim())
          .filter(Boolean);
      }
      products[index][field] = value;
    });

    tableBody.addEventListener('click', (event) => {
      const { remove } = event.target.dataset;
      if (remove !== undefined) {
        products.splice(Number(remove), 1);
        renderTable();
      }
    });

    addButton.addEventListener('click', () => {
      products.push({
        id: `producto-${Date.now()}`,
        name: '',
        category: 'baterias',
        power_w: null,
        capacity_wh: null,
        price_clp: null,
        stock: null,
        summary: '',
        images: [],
        includes: [],
        datasheet: ''
      });
      renderTable();
    });

    saveButton.addEventListener('click', () => {
      try {
        saveCatalog(products);
        setStatus('Cambios guardados. Vuelve a la landing para verificar los precios.', 'success');
      } catch (error) {
        console.error('No se pudieron guardar los cambios', error);
        setStatus('No se pudieron guardar los cambios en este navegador.', 'error');
      }
    });

    resetButton.addEventListener('click', async () => {
      clearCatalogOverride();
      setStatus('Se restauró el catálogo original.', 'success');
      await init();
    });

    exportButton.addEventListener('click', () => {
      const blob = new Blob([JSON.stringify(products, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'products.json';
      link.click();
      URL.revokeObjectURL(url);
    });

    init();
  </script>
</body>
</html>
